{
  "version": 3,
  "sources": ["../src/index.ts"],
  "sourceRoot": ".wrangler-dry-run",
  "sourcesContent": ["/**\n * Email Triage Workflow - Unified Workflow (NOT separate workers)\n * All email processing logic in ONE workflow with steps\n */\n\nimport { WorkflowEntrypoint, WorkflowEvent, WorkflowStep } from 'cloudflare:workers';\n\ninterface Env {\n\t// Workflow binding\n\tEMAIL_TRIAGE: Workflow;\n\n\t// Variables\n\tTUNNEL_URL: string;\n\tPROTON_EMAIL: string;\n\n\t// All KV namespaces\n\tEMAIL_COURTS_SUPREME_COURT: KVNamespace;\n\tEMAIL_COURTS_COURT_OF_APPEALS_CIVIL_DIVISION: KVNamespace;\n\tEMAIL_COURTS_KINGS_BENCH_APPEALS_DIVISION: KVNamespace;\n\tEMAIL_COURTS_CHANCERY_DIVISION: KVNamespace;\n\tEMAIL_COURTS_ADMINISTRATIVE_COURT: KVNamespace;\n\tEMAIL_COURTS_CENTRAL_LONDON_COUNTY_COURT: KVNamespace;\n\tEMAIL_COURTS_CLERKENWELL_COUNTY_COURT: KVNamespace;\n\tEMAIL_COMPLAINTS_ICO: KVNamespace;\n\tEMAIL_COMPLAINTS_PHSO: KVNamespace;\n\tEMAIL_COMPLAINTS_PARLIAMENT: KVNamespace;\n\tEMAIL_COMPLAINTS_HMCTS: KVNamespace;\n\tEMAIL_COMPLAINTS_BAR_STANDARDS_BOARD: KVNamespace;\n\tEMAIL_EXPENSES_LEGAL_FEES_CLAIMANT: KVNamespace;\n\tEMAIL_EXPENSES_LEGAL_FEES_COMPANY: KVNamespace;\n\tEMAIL_EXPENSES_LEGAL_FEES_DIRECTOR: KVNamespace;\n\tEMAIL_EXPENSES_REPAIRS: KVNamespace;\n\tEMAIL_CLAIMANT_HK_LAW: KVNamespace;\n\tEMAIL_CLAIMANT_LESSEL: KVNamespace;\n\tEMAIL_CLAIMANT_LIU: KVNamespace;\n\tEMAIL_CLAIMANT_RENTIFY: KVNamespace;\n\tEMAIL_DEFENDANTS_DEFENDANT: KVNamespace;\n\tEMAIL_DEFENDANTS_BOTH_DEFENDANTS: KVNamespace;\n\tEMAIL_DEFENDANTS_BARRISTERS: KVNamespace;\n\tEMAIL_DEFENDANTS_LITIGANT_IN_PERSON_ONLY: KVNamespace;\n\tEMAIL_DEFENDANTS_MOBICYCLE_OU_ONLY: KVNamespace;\n\tEMAIL_GOVERNMENT_UK_LEGAL_DEPARTMENT: KVNamespace;\n\tEMAIL_GOVERNMENT_ESTONIA: KVNamespace;\n\tEMAIL_GOVERNMENT_US_STATE_DEPARTMENT: KVNamespace;\n\tEMAIL_RECONSIDERATION_SINGLE_JUDGE: KVNamespace;\n\tEMAIL_RECONSIDERATION_COURT_OFFICER_REVIEW: KVNamespace;\n\tEMAIL_RECONSIDERATION_CPR52_24_5: KVNamespace;\n\tEMAIL_RECONSIDERATION_CPR52_24_6: KVNamespace;\n\tEMAIL_RECONSIDERATION_CPR52_30: KVNamespace;\n\tEMAIL_RECONSIDERATION_PD52B: KVNamespace;\n\tEMAIL_RECONSIDERATION_PTA_REFUSAL: KVNamespace;\n}\n\ninterface Email {\n\tid: string;\n\tfrom: string;\n\tto: string;\n\tsubject: string;\n\tbody: string;\n\tdate: string;\n\tmessageId: string;\n}\n\ninterface EmailTriageParams {\n\tbatchId?: string;\n\ttimestamp?: string;\n}\n\nexport class EmailTriageWorkflow extends WorkflowEntrypoint<Env, EmailTriageParams> {\n\n\tasync run(event: WorkflowEvent<EmailTriageParams>, step: WorkflowStep) {\n\n\t\t// Step 1: Connect to Protonmail Bridge via tunnel\n\t\tconst connection = await step.do('connect-protonmail-bridge', async () => {\n\t\t\tconst tunnelUrl = this.env.TUNNEL_URL || 'https://imap.mobicycle.ee';\n\t\t\tconsole.log(`Connecting to Protonmail Bridge at ${tunnelUrl}`);\n\n\t\t\tconst healthCheck = await fetch(`${tunnelUrl}/health`);\n\t\t\tif (!healthCheck.ok) {\n\t\t\t\tthrow new Error(`Protonmail Bridge connection failed: ${healthCheck.status}`);\n\t\t\t}\n\n\t\t\tconst health = await healthCheck.json();\n\t\t\treturn { tunnelUrl, connected: true, email: health.config?.email };\n\t\t});\n\n\t\t// Step 2: Retrieve emails from Protonmail\n\t\tconst emails = await step.do('retrieve-emails',\n\t\t\t{ retries: { limit: 3, delay: '10 seconds', backoff: 'exponential' } },\n\t\t\tasync () => {\n\t\t\t\tconst response = await fetch(`${connection.tunnelUrl}/fetch-emails`, {\n\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\theaders: { 'Content-Type': 'application/json' },\n\t\t\t\t\tbody: JSON.stringify({\n\t\t\t\t\t\taccount: this.env.PROTON_EMAIL,\n\t\t\t\t\t\tfolder: 'INBOX',\n\t\t\t\t\t\tlimit: 50,\n\t\t\t\t\t\tunseenOnly: false\n\t\t\t\t\t})\n\t\t\t\t});\n\n\t\t\t\tif (!response.ok) {\n\t\t\t\t\tthrow new Error(`Failed to fetch emails: ${response.status}`);\n\t\t\t\t}\n\n\t\t\t\tconst data = await response.json();\n\t\t\t\treturn data.emails || [];\n\t\t\t}\n\t\t);\n\n\t\tconsole.log(`Retrieved ${emails.length} emails`);\n\n\t\t// Step 3: Check whitelist and filter relevant emails\n\t\tconst relevantEmails = await step.do('filter-whitelist', async () => {\n\t\t\t// Load whitelist (in production, this would be from KV or database)\n\t\t\t// For now, accept all emails from known domains\n\t\t\tconst allowedDomains = [\n\t\t\t\t'.court', '.gov.uk', '.ee', '@ico.org.uk',\n\t\t\t\t'@ombudsman.org.uk', '@parliament.uk'\n\t\t\t];\n\n\t\t\treturn emails.filter((email: Email) => {\n\t\t\t\treturn allowedDomains.some(domain => email.from.includes(domain));\n\t\t\t});\n\t\t});\n\n\t\tconsole.log(`${relevantEmails.length} emails passed whitelist`);\n\n\t\t// Step 4: Distribute emails to appropriate KV namespaces\n\t\tconst distributed = await step.do('distribute-to-kv', async () => {\n\t\t\tconst results = [];\n\n\t\t\tfor (const email of relevantEmails) {\n\t\t\t\t// Determine KV namespace based on sender domain\n\t\t\t\tconst kvNamespace = this.getKVNamespaceForEmail(email.from);\n\n\t\t\t\tif (kvNamespace) {\n\t\t\t\t\t// Generate unique key for email\n\t\t\t\t\tconst emailKey = this.generateEmailKey(email);\n\n\t\t\t\t\t// Store email in KV\n\t\t\t\t\tawait kvNamespace.put(emailKey, JSON.stringify(email));\n\n\t\t\t\t\tresults.push({\n\t\t\t\t\t\temailId: email.id,\n\t\t\t\t\t\tfrom: email.from,\n\t\t\t\t\t\tkvKey: emailKey,\n\t\t\t\t\t\tstored: true\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn results;\n\t\t});\n\n\t\tconsole.log(`Distributed ${distributed.length} emails to KV namespaces`);\n\n\t\t// Step 5: Process each email (triage, classify, etc.)\n\t\tfor (const result of distributed) {\n\t\t\tconst emailId = result.emailId;\n\n\t\t\tawait step.do(`process-${emailId}`, async () => {\n\t\t\t\tconsole.log(`Processing email ${emailId}`);\n\t\t\t\t// Add email processing logic here\n\t\t\t\t// (classification, case linking, etc.)\n\t\t\t\treturn { processed: true, emailId };\n\t\t\t});\n\t\t}\n\n\t\t// Step 6: Log workflow completion\n\t\tawait step.do('log-completion', async () => {\n\t\t\treturn {\n\t\t\t\tworkflowId: event.instanceId,\n\t\t\t\tcompleted: new Date().toISOString(),\n\t\t\t\temailsRetrieved: emails.length,\n\t\t\t\temailsProcessed: distributed.length\n\t\t\t};\n\t\t});\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\temailsProcessed: distributed.length\n\t\t};\n\t}\n\n\t// Helper: Get KV namespace for email address\n\tprivate getKVNamespaceForEmail(emailAddress: string): KVNamespace | null {\n\t\tconst email = emailAddress.toLowerCase();\n\n\t\t// Courts\n\t\tif (email.includes('supremecourt') || email.includes('uksc')) {\n\t\t\treturn this.env.EMAIL_COURTS_SUPREME_COURT;\n\t\t}\n\t\tif (email.includes('admin.court') || email.includes('administrativecourt')) {\n\t\t\treturn this.env.EMAIL_COURTS_ADMINISTRATIVE_COURT;\n\t\t}\n\t\tif (email.includes('chancerydivision')) {\n\t\t\treturn this.env.EMAIL_COURTS_CHANCERY_DIVISION;\n\t\t}\n\n\t\t// Complaints\n\t\tif (email.includes('ico.org.uk')) {\n\t\t\treturn this.env.EMAIL_COMPLAINTS_ICO;\n\t\t}\n\t\tif (email.includes('ombudsman.org.uk')) {\n\t\t\treturn this.env.EMAIL_COMPLAINTS_PHSO;\n\t\t}\n\t\tif (email.includes('parliament.uk')) {\n\t\t\treturn this.env.EMAIL_COMPLAINTS_PARLIAMENT;\n\t\t}\n\n\t\t// Government\n\t\tif (email.includes('.ee') && email.includes('gov')) {\n\t\t\treturn this.env.EMAIL_GOVERNMENT_ESTONIA;\n\t\t}\n\t\tif (email.includes('gov.uk') && email.includes('legal')) {\n\t\t\treturn this.env.EMAIL_GOVERNMENT_UK_LEGAL_DEPARTMENT;\n\t\t}\n\n\t\t// Default: use a general namespace if available\n\t\treturn null;\n\t}\n\n\t// Helper: Generate unique email key\n\tprivate generateEmailKey(email: Email): string {\n\t\tconst emailDate = new Date(email.date);\n\t\tconst year = emailDate.getUTCFullYear();\n\t\tconst month = (emailDate.getUTCMonth() + 1).toString().padStart(2, '0');\n\t\tconst day = emailDate.getUTCDate().toString().padStart(2, '0');\n\t\tconst dateStr = `${year}.${month}.${day}`;\n\t\tconst hours = emailDate.getUTCHours().toString().padStart(2, '0');\n\t\tconst minutes = emailDate.getUTCMinutes().toString().padStart(2, '0');\n\t\tconst senderKey = email.from.replace(/[^a-zA-Z0-9@._-]/g, '_');\n\n\t\treturn `${dateStr}_${senderKey}_${hours}:${minutes}`;\n\t}\n}\n\n// Export handler to trigger workflow\nexport default {\n\tasync fetch(request: Request, env: Env): Promise<Response> {\n\t\tif (request.method !== 'POST') {\n\t\t\treturn new Response('Method not allowed', { status: 405 });\n\t\t}\n\n\t\t// Create workflow instance\n\t\tconst instance = await env.EMAIL_TRIAGE.create({\n\t\t\tparams: {\n\t\t\t\tbatchId: crypto.randomUUID(),\n\t\t\t\ttimestamp: new Date().toISOString()\n\t\t\t}\n\t\t});\n\n\t\treturn new Response(JSON.stringify({\n\t\t\tworkflowId: instance.id,\n\t\t\tstatus: 'started',\n\t\t\tmessage: 'Email triage workflow started'\n\t\t}), {\n\t\t\theaders: { 'Content-Type': 'application/json' }\n\t\t});\n\t}\n};\n"],
  "mappings": "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",
  "names": []
}
