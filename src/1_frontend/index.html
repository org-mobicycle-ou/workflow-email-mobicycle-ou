<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MobiCycle OÜ Email Workflow Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">MobiCycle OÜ Email Workflow Dashboard</h1>
                <p class="text-gray-600 mt-2">rose@mobicycle.ee | ProtonMail Bridge → Backend → Cloudflare Worker → KV Storage</p>
            </div>
        </header>

        <!-- Tabs -->
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="border-b border-gray-200 mt-6">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="switchTab('localhost4000')" id="tab-localhost4000" class="border-b-2 border-blue-500 py-2 px-1 text-sm font-medium text-blue-600">
                        localhost:4000
                    </button>
                    <button onclick="switchTab('localhost1143')" id="tab-localhost1143" class="border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                        localhost:1143
                    </button>
                    <button onclick="switchTab('kvraw')" id="tab-kvraw" class="border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                        KV - Data - Raw
                    </button>
                    <button onclick="switchTab('kvfiltered')" id="tab-kvfiltered" class="border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                        KV - Data - Filtered
                    </button>
                    <button onclick="switchTab('kvfolders')" id="tab-kvfolders" class="border-b-2 border-transparent py-2 px-1 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                        KV - Folders
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="py-6">
                <!-- Tab 1: localhost:4000 -->
                <div id="localhost4000" class="block">
                    <h2 class="text-2xl font-bold mb-4">Backend Server (localhost:4000)</h2>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Server Status</h3>
                        <div id="backend-status" class="text-gray-600">Loading...</div>
                        
                        <h3 class="text-lg font-semibold mb-4 mt-6">Available Endpoints</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="border p-4 rounded">
                                <h4 class="font-medium">Email Operations</h4>
                                <ul class="text-sm text-gray-600 mt-2 space-y-1">
                                    <li>POST /fetch-emails</li>
                                    <li>POST /send-email</li>
                                    <li>GET /email-count</li>
                                    <li>GET /list-folders</li>
                                </ul>
                            </div>
                            <div class="border p-4 rounded">
                                <h4 class="font-medium">Health & Stats</h4>
                                <ul class="text-sm text-gray-600 mt-2 space-y-1">
                                    <li>GET /health</li>
                                    <li>GET /account-info</li>
                                    <li>GET /account-stats</li>
                                    <li>GET /total-emails</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: localhost:1143 -->
                <div id="localhost1143" class="hidden">
                    <h2 class="text-2xl font-bold mb-4">ProtonMail Bridge (localhost:1143)</h2>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Bridge Status</h3>
                        <div id="bridge-status" class="text-gray-600">Loading...</div>
                        
                        <h3 class="text-lg font-semibold mb-4 mt-6">Connection Info</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="border p-4 rounded">
                                <h4 class="font-medium">IMAP</h4>
                                <p class="text-sm text-gray-600">Port: 1143</p>
                                <p class="text-sm text-gray-600">Email: rose@mobicycle.ee</p>
                            </div>
                            <div class="border p-4 rounded">
                                <h4 class="font-medium">SMTP</h4>
                                <p class="text-sm text-gray-600">Port: 1025</p>
                                <p class="text-sm text-gray-600">Outgoing mail</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: KV - Data - Raw -->
                <div id="kvraw" class="hidden">
                    <h2 class="text-2xl font-bold mb-4">KV - Raw Data (RAW_DATA_HEADERS)</h2>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Raw Email Storage</h3>
                        <div id="raw-data-status" class="text-gray-600 mb-4">Loading...</div>
                        <div id="raw-data-content" class="text-sm"></div>
                    </div>
                </div>

                <!-- Tab 4: KV - Data - Filtered -->
                <div id="kvfiltered" class="hidden">
                    <h2 class="text-2xl font-bold mb-4">KV - Filtered Data (FILTERED_DATA_HEADERS)</h2>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Filtered Email Storage</h3>
                        <div id="filtered-data-status" class="text-gray-600 mb-4">Loading...</div>
                        <div id="filtered-data-content" class="text-sm"></div>
                    </div>
                </div>

                <!-- Tab 5: KV - Folders -->
                <div id="kvfolders" class="hidden">
                    <h2 class="text-2xl font-bold mb-4">KV - Legal Folders</h2>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Legal Category Namespaces</h3>
                        <div id="folders-status" class="text-gray-600 mb-4">Loading...</div>
                        <div id="folders-content" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            // Hide all tabs
            const tabs = ['localhost4000', 'localhost1143', 'kvraw', 'kvfiltered', 'kvfolders'];
            tabs.forEach(tab => {
                const element = document.getElementById(tab);
                element.classList.add('hidden');
                element.classList.remove('block');
                
                const button = document.getElementById(`tab-${tab}`);
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('border-transparent', 'text-gray-500');
            });

            // Show selected tab
            const selectedTab = document.getElementById(tabName);
            selectedTab.classList.remove('hidden');
            selectedTab.classList.add('block');
            
            const selectedButton = document.getElementById(`tab-${tabName}`);
            selectedButton.classList.remove('border-transparent', 'text-gray-500');
            selectedButton.classList.add('border-blue-500', 'text-blue-600');

            // Load tab content
            loadTabContent(tabName);
        }

        async function loadTabContent(tabName) {
            const token = 'mobicycle-workflows-2026';
            
            try {
                switch(tabName) {
                    case 'localhost4000':
                        const healthResponse = await fetch(`/health?token=${token}`);
                        const healthData = await healthResponse.json();
                        document.getElementById('backend-status').innerHTML = `
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-${healthData.overall === 'healthy' ? 'green' : 'red'}-500 rounded-full"></div>
                                <span>Status: ${healthData.overall}</span>
                            </div>
                            <p class="text-sm mt-2">Bridge: ${healthData.bridge?.status || 'Unknown'}</p>
                            <p class="text-sm">Tunnel: ${healthData.tunnel?.status || 'Unknown'}</p>
                        `;
                        break;
                        
                    case 'localhost1143':
                        document.getElementById('bridge-status').innerHTML = 'ProtonMail Bridge connection details...';
                        break;
                        
                    case 'kvraw':
                        const rawResponse = await fetch(`/api/kv-emails/raw-data?token=${token}&limit=5`);
                        const rawData = await rawResponse.json();
                        document.getElementById('raw-data-status').innerHTML = `Total emails: ${rawData.count || 0}`;
                        document.getElementById('raw-data-content').innerHTML = rawData.emails ? 
                            rawData.emails.map(email => `
                                <div class="border p-3 rounded mb-2">
                                    <div class="font-medium">${email.key}</div>
                                    <div class="text-xs text-gray-500">From: ${email.data.from}</div>
                                    <div class="text-xs text-gray-500">Subject: ${email.data.subject}</div>
                                </div>
                            `).join('') : 'No emails found';
                        break;
                        
                    case 'kvfiltered':
                        const filteredResponse = await fetch(`/api/kv-emails/filtered-data?token=${token}&limit=5`);
                        const filteredData = await filteredResponse.json();
                        document.getElementById('filtered-data-status').innerHTML = `Total emails: ${filteredData.count || 0}`;
                        document.getElementById('filtered-data-content').innerHTML = filteredData.emails ? 
                            filteredData.emails.map(email => `
                                <div class="border p-3 rounded mb-2">
                                    <div class="font-medium">${email.key}</div>
                                    <div class="text-xs text-gray-500">From: ${email.data.from}</div>
                                    <div class="text-xs text-gray-500">Namespace: ${email.data.namespace}</div>
                                </div>
                            `).join('') : 'No emails found';
                        break;
                        
                    case 'kvfolders':
                        const foldersResponse = await fetch(`/api/kv-counts?token=${token}`);
                        const foldersData = await foldersResponse.json();
                        document.getElementById('folders-status').innerHTML = `Total namespaces: ${foldersData.namespaces?.length || 0}`;
                        document.getElementById('folders-content').innerHTML = foldersData.namespaces ? 
                            foldersData.namespaces.filter(ns => ns.count > 0).map(ns => `
                                <div class="border p-4 rounded">
                                    <div class="font-medium">${ns.name}</div>
                                    <div class="text-sm text-gray-500">${ns.category}</div>
                                    <div class="text-lg font-bold text-blue-600">${ns.count} emails</div>
                                </div>
                            `).join('') : 'No folders with emails';
                        break;
                }
            } catch (error) {
                console.error('Error loading tab content:', error);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadTabContent('localhost4000');
        });
    </script>
</body>
</html>